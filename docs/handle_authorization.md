# 認証処理

## ログイン処理

### ユーザーの取得

受け取ったEメールアドレスを基に、ユーザーリポジトリからユーザーを取得する。
ユーザーを取得できなかった場合は、`403 Unauthorized`を返す。

### ユーザーのアクティブフラグの確認

取得したユーザーのアクティブフラグを確認し、ロックされている（アクティブでない）場合は`423 Locked`を返す。

### パスワードの検証

取得したユーザーのハッシュ化されたパスワード（PHC形式）と、受け取ったパスワードを比較して検証する。

#### パスワードの検証に成功した場合

パスワードの検証に成功した場合、以下の処理を行い、アクセストークンとリフレッシュトークンを`200 OK`レスポンスで返す。

- アクセストークンとリフレッシュトークンを生成する。
- ユーザーの最終ログイン日時を、ログインリクエストの受信日時に更新する。
- トークンリポジトリに対して、以下を登録する。
  - アクセストークンをハッシュ化し、そのハッシュ値をキーとして、ユーザーIDとトークン種別の識別子を、アクセストークンの有効期限とともに保存する。
  - リフレッシュトークンも同様にハッシュ化し、上記と同様の情報を保存する。
- ユーザーのログイン失敗履歴を削除する。
- ユーザーリポジトリに対して、以下を登録する（トークン失効管理のため）。
  - ユーザーID、ハッシュ化したアクセストークン、アクセストークンの無効化日時。
  - ユーザーID、ハッシュ化したリフレッシュトークン、リフレッシュトークンの無効化日時。
- レスポンスヘッダに`Set-Cookie`を追加し、以下の属性でトークンをクッキーに保存する。
  - `Key/Value`: `access_token`/ アクセストークン、`refresh_token` / リフレッシュトークン
  - `Domain`: 本アプリのドメイン
  - `Path`: `/`
  - `HttpOnly`: JavaScriptからのアクセスを防ぐ
  - `Secure`: HTTPS通信時のみ付与
  - `SameSite`: `Strict`に設定し、CSRF対策を行う
  - `Max-Age`: アクセストークンの有効期限（秒単位）

#### パスワードの検証に失敗した場合

ユーザーのログイン失敗履歴を取得し、以下の処理を行った後、`401 Unauthorized`を返す。

##### ログイン失敗履歴が存在しない場合

以下の情報をログイン失敗履歴に追加する。

- ログイン試行回数: 1
- ログイン試行開始日時: ログインリクエストの受信日時

##### ログイン失敗履歴が存在する場合

ログイン失敗履歴のログイン試行開始日時を確認する。

###### 経過時間が連続ログイン試行許容時間未満の場合

```text
ログインリクエスト受信日時 - ログイン試行開始日時 < 連続ログイン試行許容時間
```

- ログイン試行回数を1回増やす。
- ログイン試行回数が連続ログイン試行許容回数を超えた場合は、ユーザーのアクティブフラグを無効にしてロックする。

###### 経過時間が連続ログイン試行許容時間以上の場合

```text
ログインリクエスト受信日時 - ログイン試行開始日時 >= 連続ログイン試行許容時間
```

ログイン試行回数を1にリセットし、ログイン試行開始日時をログインリクエスト受信日時に更新する。

### 実装方針

### ユースケース層

ログインのすべての処理は、インフラストラクチャ層で実装する。

## ログアウト処理

ログアウトリクエストを受け取ったら、次を処理する。

- 対象ユーザーのユーザーIDを基に、ユーザーリポジトリからハッシュ化されたアクセストークンとリフレッシュトークンを削除する。
- 上記で削除したハッシュ値をキーとして、トークンリポジトリから該当レコードを削除する。
- レスポンスヘッダに`Set-Cookie`を追加し、以下の属性でクッキーを無効化する。
  - `Key/Value`: `access_token` / 空文字列、`refresh_token` / 空文字列
  - `Domain`: 本アプリのドメイン
  - `Path`: `/`
  - `HttpOnly`: JavaScriptからのアクセスを防ぐ
  - `Secure`: HTTPS通信時のみ付与
  - `SameSite`: `Strict`に設定し、CSRF対策を行う
  - `Max-Age`: 0（クッキーを即時削除）
- HTTPステータスコード`204 No Content`を返す。

### 実装方針

ログアウトのすべての処理は、インフラストラクチャ層で実装する。

## バッチ処理

### ユーザーリポジトリからのハッシュ化されたトークンの削除

ユーザーがログアウトしない場合、ユーザーリポジトリに保存されているハッシュ化されているアクセストークンとリフレッシュトークンが削除されない。
したがって、バッチ処理で期限切れとなったトークンを削除する。
