# 認証処理

## ログイン処理

### リクエストの受信

ログインリクエストとして、Eメールアドレスとパスワードを受け取り、リクエスト受信日時を記録します。

### ユーザーの取得

受け取ったEメールアドレスを基に、ユーザーリポジトリからユーザーを取得します。
該当するユーザーが存在しない場合は、`403 Unauthorized`を返します。

### ユーザーのアクティブフラグの確認

取得したユーザーのアクティブフラグを確認し、ユーザーがロックされている場合は、`423 Locked`を返します。

### パスワードの検証

取得したユーザーのハッシュ化されたパスワード（PHC形式）と、受け取ったパスワードを照合します。

#### パスワードの検証に成功した場合

パスワードの検証に成功した場合は、以下の処理を行い、アクセストークンとリフレッシュトークンを、`200 OK`で返します。

- アクセストークンとリフレッシュトークンを生成
- トークンリポジトリに対して、以下を実施
  - アクセストークンのハッシュ値をキー、ユーザーIDとトークン種別の識別子を連結した文字列を値として、アクセストークンの有効期限を設定してレコードを登録
  - リフレッシュトークンも同様に登録
- ユーザーリポジトリに対して、以下を実施
  - ユーザーの最終ログイン日時を、ログインリクエストの受信日時に更新
  - ユーザーのログイン失敗履歴を削除
  - ユーザーID、アクセストークンのハッシュ値、アクセストークンの有効期限を登録
  - ユーザーID、リフレッシュトークンのハッシュ値、リフレッシュトークンの有効期限を登録
- レスポンスヘッダーに、次の属性を持つ`Set-Cookie`ヘッダーを追加して、アクセストークンとリフレッシュトークンをクッキーに設定
  - `Key/Value`: `access_token`/ アクセストークン、`refresh_token` / リフレッシュトークン
  - `Domain`: 本アプリのドメイン
  - `Path`: `/`
  - `HttpOnly`: JavaScriptからのアクセスを防ぐ
  - `Secure`: HTTPS通信時のみ付与
  - `SameSite`: `Strict`に設定し、CSRF対策を行う
  - `Max-Age`: アクセストークンの有効期限（秒単位）

#### パスワードの検証に失敗した場合

ユーザーのログイン失敗履歴を取得し、以下の処理を行った後、`401 Unauthorized`を返します。

##### ログイン失敗履歴が存在しない場合

以下の情報をログイン失敗履歴に登録します。

- ログイン試行回数: 1
- ログイン試行開始日時: ログインリクエストの受信日時

##### ログイン失敗履歴が存在する場合

ログイン失敗履歴のログイン試行開始日時を確認します。

###### 経過時間が連続ログイン試行許容時間未満の場合

```text
ログインリクエスト受信日時 - ログイン試行開始日時 < 連続ログイン試行許容時間
```

- ログイン試行回数をインクリメント
- ログイン試行回数が連続ログイン試行許容回数を超えた場合は、ユーザーのアクティブフラグを無効にしてロック

###### 経過時間が連続ログイン試行許容時間以上の場合

```text
ログインリクエスト受信日時 - ログイン試行開始日時 >= 連続ログイン試行許容時間
```

- ログイン試行回数を1にリセットし、ログイン試行開始日時をログインリクエスト受信日時に更新

### 実装方針

ログインのすべての処理は、インフラストラクチャ層で実装します。

## ログアウト処理

ログアウトリクエストを受け取ったら、次を処理します。

- 対象ユーザーのユーザーIDを基に、ユーザーリポジトリからハッシュ化されたアクセストークンとリフレッシュトークンを削除
- 上記で削除したハッシュ値をキーとして、トークンリポジトリからレコードを削除
- レスポンスヘッダーに次の属性を持つ`Set-Cookie`を追加して、クッキーに保存されたアクセストークンとリフレッシュトークンを無効化
  - `Key/Value`: `access_token` / 空文字列、`refresh_token` / 空文字列
  - `Domain`: 本アプリのドメイン
  - `Path`: `/`
  - `HttpOnly`: JavaScriptからのアクセスを防ぐ
  - `Secure`: HTTPS通信時のみ付与
  - `SameSite`: `Strict`に設定し、CSRF対策を行う
  - `Max-Age`: 0（クッキーを即時削除）
- HTTPステータスコード`204 No Content`を返す。

### 実装方針

ログアウトのすべての処理は、インフラストラクチャ層で実装します。

## バッチ処理

### ユーザーリポジトリからのハッシュ化されたトークンの削除

ユーザーが明示的にログアウトしない場合、ユーザーリポジトリに保存されているハッシュ化されたアクセストークンとリフレッシュトークンが削除されません。
したがって、バッチ処理で期限切れとなったトークンを削除するようにします。
